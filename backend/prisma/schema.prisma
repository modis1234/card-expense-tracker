generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String         @id @default(uuid())
  email        String         @unique
  password     String?
  name         String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  googleId     String?        @unique(map: "users_googleid_key")
  picture      String?
  provider     String?        @default("local")
  files        File[]
  transactions Transaction[]
  feedbacks    UserFeedback[]

  @@map("users")
}

model Category {
  id           String         @id @default(uuid())
  name         String
  icon         String
  color        String
  order        Int
  isActive     Boolean        @default(true)
  parentId     String?
  parent       Category?      @relation("CategoryTree", fields: [parentId], references: [id], onDelete: Restrict)
  children     Category[]     @relation("CategoryTree")
  transactions Transaction[]
  newFeedbacks UserFeedback[] @relation("NewCategory")
  oldFeedbacks UserFeedback[] @relation("OldCategory")

  @@index([parentId])
  @@index([isActive, order])
  @@map("categories")
}

model Transaction {
  id           String         @id @default(uuid())
  date         DateTime       @db.Date
  amount       Int
  description  String?
  confidence   Decimal?       @db.Decimal(3, 2)
  cardCompany  String
  categoryId   String
  createdAt    DateTime       @default(now())
  fileId       String?
  merchantName String
  needsReview  Boolean        @default(false)
  updatedAt    DateTime       @updatedAt
  userId       String
  category     Category       @relation(fields: [categoryId], references: [id])
  file         File?          @relation(fields: [fileId], references: [id])
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  feedbacks    UserFeedback[]

  @@index([userId, date(sort: Desc)])
  @@index([categoryId])
  @@index([userId, categoryId, date])
  @@index([needsReview])
  @@map("transactions")
}

model File {
  id           String        @id @default(uuid())
  filename     String
  status       String        @default("completed")
  cardCompany  String
  fileSize     Int
  fileUrl      String
  originalName String
  uploadedAt   DateTime      @default(now())
  userId       String
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([userId, uploadedAt(sort: Desc)])
  @@map("files")
}

model UserFeedback {
  id            String      @id @default(uuid())
  createdAt     DateTime    @default(now())
  merchantName  String
  newCategoryId String
  oldCategoryId String
  transactionId String
  userId        String
  newCategory   Category    @relation("NewCategory", fields: [newCategoryId], references: [id])
  oldCategory   Category    @relation("OldCategory", fields: [oldCategoryId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([merchantName])
  @@index([userId, createdAt(sort: Desc)])
  @@map("user_feedbacks")
}
